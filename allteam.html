<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PuckCalcs: WIATC</title>
  <style>
    body { 
      font-family: Mono; 
      background: #fff; text-align: center;}
    .main { max-width: 900px; margin: 10px auto;
    }
    table { border-collapse: separate; margin-top: 10px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; }
    th { background: #e7e7e7; }
    .pick-btn { margin: 0 1px; padding: 2px 7px; border-radius: 4px; border: 1px solid #aaa; cursor: pointer; font-family: Mono;}
    .selected { 
      background: #222; 
      border: 2px solid #222; 
    color: #fff; font-family: Mono; }
    .myteam { background: #f8e6b5 !important; }
    .highlight { background: #dff0d8; }
    #gamesList { max-height: 340px; overflow: auto; }
    .small { 
      font-size: 0.9em; 
      color: #555; }
    #teamSelect { margin-bottom: 18px; }
    .sidebar {
      width: 7%;
      min-width: 44px;
      padding: 6px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      max-height: 100vh;
      overflow-y: visible;
      position: sticky;
      top: 0;
    }
    .sidebar img {
      width: 28px;
      height: 38px;
      display: block;
      object-fit: contain;
      margin-bottom: 2px; 
    }
    .sidebar-label {
      font-size: 0.8em;
      font-weight: bold;
      margin-bottom: 4px;
      margin-top: 8px;
      text-align: center;
    }
    .page-container {
      display: flex;
    }
    .viewBtn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #f0f0f0;
      cursor: pointer;
      font-family: Mono;
    }
    .viewBtn.selected {
      background: #222;
      color: #fff;
      font-weight: bold;
    }
    @media (max-width: 900px) {
      .sidebar {
        display: none;
      }
      .main {
        width: 100%;
      }
      .page-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="sidebar east" id="east-sidebar"></div>
    <div class="main">
      <h1>What-If All Team Calc</h1>
      <label for="teamSelect">Pick your team: </label>
      <select id="teamSelect">
        <option value="" disabled selected>Select a team</option>
      </select>
      <div style="margin-top: 10px; margin-bottom:10px;">
        <button class="viewBtn" data-view="league">League</button>
        <button class="viewBtn" data-view="conference">Conference</button>
        <button class="viewBtn" data-view="division">Division</button>
      </div>
      <div id="gamesList">Loading schedule...</div>
      <div id="standings"></div>
    </div>
    <div class="sidebar west" id="west-sidebar"></div>
  </div>
<script>

const CORS_PROXY = "https://corsproxy.io/?";
const SCHEDULE_API_BASE = "https://api-web.nhle.com/v1/club-schedule-season";
const STANDINGS_API = "https://api-web.nhle.com/v1/standings/now";
const TOTAL_GAMES = 82;

const abbrevToFull = {
  "ANA": "Anaheim Ducks", "ARI": "Arizona Coyotes", "BOS": "Boston Bruins", "BUF": "Buffalo Sabres",
  "CGY": "Calgary Flames", "CAR": "Carolina Hurricanes", "CHI": "Chicago Blackhawks", "COL": "Colorado Avalanche",
  "CBJ": "Columbus Blue Jackets", "DAL": "Dallas Stars", "DET": "Detroit Red Wings", "EDM": "Edmonton Oilers",
  "FLA": "Florida Panthers", "LAK": "Los Angeles Kings", "MIN": "Minnesota Wild", "MTL": "Montreal Canadiens",
  "NSH": "Nashville Predators", "NJD": "New Jersey Devils", "NYI": "New York Islanders", "NYR": "New York Rangers",
  "OTT": "Ottawa Senators", "PHI": "Philadelphia Flyers", "PIT": "Pittsburgh Penguins", "SJS": "San Jose Sharks",
  "SEA": "Seattle Kraken", "STL": "St. Louis Blues", "TBL": "Tampa Bay Lightning", "TOR": "Toronto Maple Leafs",
  "VAN": "Vancouver Canucks", "VGK": "Vegas Golden Knights", "WSH": "Washington Capitals", "WPG": "Winnipeg Jets"
};

const eastTeams = [
  "Boston Bruins", "Buffalo Sabres", "Detroit Red Wings", "Florida Panthers", "Montreal Canadiens", "Ottawa Senators", "Tampa Bay Lightning", "Toronto Maple Leafs",
  "Carolina Hurricanes", "Columbus Blue Jackets", "Philadelphia Flyers", "Pittsburgh Penguins", "New Jersey Devils", "New York Islanders", "New York Rangers", "Washington Capitals"
];
const westTeams = [
  "Chicago Blackhawks", "Colorado Avalanche", "Dallas Stars", "Minnesota Wild", "Nashville Predators", "St. Louis Blues", "Winnipeg Jets",
  "Anaheim Ducks", "Arizona Coyotes", "Calgary Flames", "Edmonton Oilers", "Los Angeles Kings", "San Jose Sharks", "Vancouver Canucks", "Vegas Golden Knights"
];
const teamAbbrevs = {
  "Anaheim Ducks": "ANA", "Arizona Coyotes": "ARI", "Boston Bruins": "BOS", "Buffalo Sabres": "BUF",
  "Calgary Flames": "CGY", "Carolina Hurricanes": "CAR", "Chicago Blackhawks": "CHI", "Colorado Avalanche": "COL",
  "Columbus Blue Jackets": "CBJ", "Dallas Stars": "DAL", "Detroit Red Wings": "DET", "Edmonton Oilers": "EDM",
  "Florida Panthers": "FLA", "Los Angeles Kings": "LAK", "Minnesota Wild": "MIN", "Montreal Canadiens": "MTL",
  "Nashville Predators": "NSH", "New Jersey Devils": "NJD", "New York Islanders": "NYI", "New York Rangers": "NYR",
  "Ottawa Senators": "OTT", "Philadelphia Flyers": "PHI", "Pittsburgh Penguins": "PIT", "San Jose Sharks": "SJS",
  "Seattle Kraken": "SEA", "St. Louis Blues": "STL", "Tampa Bay Lightning": "TBL", "Toronto Maple Leafs": "TOR",
  "Vancouver Canucks": "VAN", "Vegas Golden Knights": "VGK", "Washington Capitals": "WSH", "Winnipeg Jets": "WPG"
};

const teamStructure = {
  "Eastern Conference": {
    "Atlantic Division": [
      "Boston Bruins", "Buffalo Sabres", "Detroit Red Wings", "Florida Panthers",
      "Montreal Canadiens", "Ottawa Senators", "Tampa Bay Lightning", "Toronto Maple Leafs"
    ],
    "Metropolitan Division": [
      "Carolina Hurricanes", "Columbus Blue Jackets", "Philadelphia Flyers",
      "Pittsburgh Penguins", "New Jersey Devils", "New York Islanders",
      "New York Rangers", "Washington Capitals"
    ]
  },
  "Western Conference": {
    "Central Division": [
      "Chicago Blackhawks", "Colorado Avalanche", "Dallas Stars", "Minnesota Wild",
      "Nashville Predators", "St. Louis Blues", "Winnipeg Jets"
    ],
    "Pacific Division": [
      "Anaheim Ducks", "Arizona Coyotes", "Calgary Flames", "Edmonton Oilers",
      "Los Angeles Kings", "San Jose Sharks", "Vancouver Canucks", "Vegas Golden Knights"
    ]
  }
};

function populateSidebar(sidebarId, teams) {
  fetch('https://api-web.nhle.com/v1/standings/2025-02-10')
    .then(res => res.json())
    .then(data => {
      const logoMap = {};
      data.standings.forEach(team => {
        logoMap[team.teamName.default] = team.teamLogo;
      });
      const sidebar = document.getElementById(sidebarId);
      teams.forEach(name => {
        const img = document.createElement('img');
        img.src = logoMap[name] || `https://assets.nhle.com/logos/nhl/svg/${teamAbbrevs[name]}_light.svg`;
        img.alt = name;
        img.title = name;
        sidebar.appendChild(img);
      });
    })
    .catch(() => {
      const sidebar = document.getElementById(sidebarId);
      teams.forEach(name => {
        const img = document.createElement('img');
        img.src = `https://assets.nhle.com/logos/nhl/svg/${teamAbbrevs[name]}_light.svg`;
        img.alt = name;
        img.title = name;
        sidebar.appendChild(img);
      });
    });
}
populateSidebar('east-sidebar', eastTeams);
populateSidebar('west-sidebar', westTeams);

let allTeams = [];
let standingsBase = {};
let scheduleGames = [];
let userPicks = [];
let selectedTeam = "";
let selectedConference = null;
let selectedDivision = null;
let currentView = "league"; // league, conference, division

function outcomeText(v) {
  if (!v) return "?";
  if (v==='home') return "Home W (2-0)";
  if (v==='away') return "Away W (0-2)";
  if (v==='home_ot') return "Home OTW (2-1)";
  if (v==='away_ot') return "Away OTW (1-2)";
}
function getPoints(result) {
  // returns: [home pts, away pts]
  if (result === "home") return [2,0];
  if (result === "away") return [0,2];
  if (result === "home_ot") return [2,1];
  if (result === "away_ot") return [1,2];
  return [0,0];
}

function findTeamGroup(teamName) {
  for (const conference in teamStructure) {
    for (const division in teamStructure[conference]) {
      if (teamStructure[conference][division].includes(teamName)) {
        return { conference, division };
      }
    }
  }
  return { conference: null, division: null };
}

function filterStandings(viewType, standings) {
  if (viewType === "league") return standings;
  if (!selectedTeam) return standings;
  if (viewType === "conference") {
    const conferenceDivisions = teamStructure[selectedConference];
    const allConferenceTeams = Object.values(conferenceDivisions).flat();
    return standings.filter(t => allConferenceTeams.includes(t.name));
  }
  if (viewType === "division") {
    return standings.filter(t =>
      teamStructure[selectedConference]?.[selectedDivision]?.includes(t.name)
    );
  }
  return standings;
}

async function loadTeamsAndSchedule() {
  // Load standings and teams
  const standings = await fetch(CORS_PROXY+encodeURIComponent(STANDINGS_API)).then(r=>r.json());
  allTeams = standings.standings.map(t=>t.teamName.default);
  standingsBase = {};
  standings.standings.forEach((t,i)=> {
    standingsBase[t.teamName.default] = {
      name: t.teamName.default, points: t.points, gamesPlayed: t.gamesPlayed
    };
  });
  // Fill dropdown
  const sel = document.getElementById("teamSelect");
  sel.innerHTML = '<option value="" disabled selected>Select a team</option>';
  allTeams.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  });
  // Load schedule for ALL TEAMS using the new API structure
  scheduleGames = [];
  for (const team of allTeams) {
    const abbrev = teamAbbrevs[team];
    const url = CORS_PROXY + encodeURIComponent(`${SCHEDULE_API_BASE}/${abbrev}/now`);
    try {
      const sch = await fetch(url).then(r=>r.json());
      if (Array.isArray(sch.games)) {
        sch.games.forEach(game=>{
          const homeAbbrev = game.homeTeamAbbrev || game.homeTeam?.abbrev;
          const awayAbbrev = game.awayTeamAbbrev || game.awayTeam?.abbrev;
          const home = abbrevToFull[homeAbbrev];
          const away = abbrevToFull[awayAbbrev];
          if (!home || !away) return;
          // Avoid duplicate games (some teams may repeat the same games!)
          const uniqueId = `${game.id}_${home}_${away}`;
          if (!scheduleGames.some(g=>g.uniqueId===uniqueId)) {
            scheduleGames.push({
              date: game.gameDate || game.gameDateUTC || game.startTimeUTC || game.startTime,
              home, away,
              id: game.id,
              uniqueId
            });
          }
        });
      }
    } catch (e) {
      // If error, just skip this team
    }
  }
  userPicks = Array(scheduleGames.length).fill(null);
  drawGames();
  simulate();
}

function pick(idx, v) {
  userPicks[idx] = v;
  drawGames();
  simulate();
}

function drawGames() {
  let html = `<table><tr><th>Date</th><th>Home</th><th>Away</th><th>Outcome</th></tr>`;
  if (scheduleGames.length === 0) {
    html += `<tr><td colspan="4">(No future games in schedule API)</td></tr>`;
  } else {
    scheduleGames.forEach((g, idx)=>{
      const isMyTeam = g.home===selectedTeam || g.away===selectedTeam;
      html += `<tr${isMyTeam?' class="myteam"':''}>
        <td>${g.date}</td>
        <td>${g.home}</td>
        <td>${g.away}</td>
        <td>
          <button class="pick-btn${userPicks[idx]==='home'?' selected':''}" onclick="pick(${idx},'home')">Home</button>
          <button class="pick-btn${userPicks[idx]==='away'?' selected':''}" onclick="pick(${idx},'away')">Away</button>
          <button class="pick-btn${userPicks[idx]==='home_ot'?' selected':''}" onclick="pick(${idx},'home_ot')">Home OT</button>
          <button class="pick-btn${userPicks[idx]==='away_ot'?' selected':''}" onclick="pick(${idx},'away_ot')">Away OT</button>
          <button class="pick-btn${userPicks[idx]==null?' selected':''}" onclick="pick(${idx},null)">?</button>
          <span class="small">${outcomeText(userPicks[idx])}</span>
        </td>
      </tr>`;
    });
  }
  html+="</table>";
  document.getElementById("gamesList").innerHTML = html;
}

function simulate() {
  // Clone standings
  let standings = {};
  for (const t of allTeams) standings[t] = {...standingsBase[t]};
  // Simulate picked games
  scheduleGames.forEach((g, idx)=>{
    const pick = userPicks[idx];
    if (!pick) return;
    const [h, a] = getPoints(pick);
    standings[g.home].points += h;
    standings[g.home].gamesPlayed += 1;
    standings[g.away].points += a;
    standings[g.away].gamesPlayed += 1;
  });
  // Render standings table with filter
  let arr = Object.values(standings);
  arr = filterStandings(currentView, arr);
  arr = arr.sort((a,b)=>b.points-a.points);
  let html = `<h3>Projected Standings</h3><table><tr><th>Rank</th><th>Team</th><th>Pts</th><th>GP</th></tr>`;
  arr.forEach((t,i)=>{
    html += `<tr${t.name===selectedTeam?' class="highlight"':''}><td>${i+1}</td><td>${t.name}</td><td>${t.points}</td><td>${t.gamesPlayed}</td></tr>`;
  });
  html+="</table>";
  document.getElementById("standings").innerHTML = html;
}

document.getElementById("teamSelect").addEventListener("change", function() {
  selectedTeam = this.value;
  const group = findTeamGroup(selectedTeam);
  selectedConference = group.conference;
  selectedDivision = group.division;
  drawGames();
  // When team changes, reset to league view by default
  document.querySelectorAll('.viewBtn').forEach(btn => btn.classList.remove('selected'));
  document.querySelector('.viewBtn[data-view="league"]').classList.add('selected');
  currentView = "league";
  simulate();
});

document.querySelectorAll('.viewBtn').forEach(btn => {
  btn.addEventListener('click', function() {
    currentView = this.getAttribute('data-view');
    document.querySelectorAll('.viewBtn').forEach(b => b.classList.remove('selected'));
    this.classList.add('selected');
    simulate();
  });
});

loadTeamsAndSchedule();
</script>
</body>
</html>
